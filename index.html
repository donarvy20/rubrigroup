<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evaluador con Rúbricas por Grupos</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <style>
        body {
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1200px;
        }
        .card {
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 8px rgba(0,0,0,0.05);
        }
        .student-list-item, .group-member-item {
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .student-list-item:hover {
            background-color: #e9ecef;
        }
        .student-list-item.selected {
            background-color: #0d6efd;
            color: white;
            font-weight: bold;
        }
        .student-list-item.unavailable {
            background-color: #e9ecef;
            color: #adb5bd;
            cursor: not-allowed;
            text-decoration: line-through;
        }
        .rubric-table th, .rubric-table td {
            vertical-align: middle;
        }
        .rubric-table .descriptor {
            font-size: 0.85rem;
            color: #6c757d;
        }
        .level-header {
            font-size: 0.9rem;
            font-weight: bold;
        }
        .evaluation-results {
            font-size: 1.2rem;
            font-weight: bold;
        }
        .btn-group-sm > .btn {
             font-size: 0.75rem;
        }
        .nav-tabs .nav-link {
            color: #495057;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            border-color: #dee2e6 #dee2e6 #fff;
            font-weight: bold;
        }
        #results-area .card-header, #final-results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        /* --- Estilos para la celda seleccionable --- */
        .selectable-cell {
            cursor: pointer;
            transition: background-color 0.2s, box-shadow 0.2s;
        }
        .selectable-cell:hover {
            background-color: #e0f2fe; /* Celeste claro */
        }
        .selectable-cell.selected-cell {
            background-color: #0d6efd;
            color: white;
            box-shadow: inset 0 0 0 3px #0a58ca;
        }
        .selectable-cell.selected-cell .descriptor,
        .selectable-cell.selected-cell strong {
            color: white !important;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="h3">
                <i class="bi bi-card-checklist"></i> Evaluador con Rúbricas por Grupos
            </h1>
            <button id="clear-all-data" class="btn btn-sm btn-danger"><i class="bi bi-trash"></i> Limpiar Todos los Datos</button>
        </div>

        <!-- Pestañas de Navegación -->
        <ul class="nav nav-tabs" id="mainTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="setup-tab" data-bs-toggle="tab" data-bs-target="#setup-pane" type="button" role="tab" aria-controls="setup-pane" aria-selected="true"><i class="bi bi-gear-fill"></i> 1. Configuración</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="rubric-tab" data-bs-toggle="tab" data-bs-target="#rubric-pane" type="button" role="tab" aria-controls="rubric-pane" aria-selected="false"><i class="bi bi-table"></i> 2. Rúbrica</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="groups-tab" data-bs-toggle="tab" data-bs-target="#groups-pane" type="button" role="tab" aria-controls="groups-pane" aria-selected="false"><i class="bi bi-people-fill"></i> 3. Grupos</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="evaluate-tab" data-bs-toggle="tab" data-bs-target="#evaluate-pane" type="button" role="tab" aria-controls="evaluate-pane" aria-selected="false"><i class="bi bi-pencil-square"></i> 4. Evaluar</button>
            </li>
        </ul>

        <!-- Contenido de las Pestañas -->
        <div class="tab-content" id="mainTabContent">
            
            <!-- Pestaña 1: Configuración -->
            <div class="tab-pane fade show active" id="setup-pane" role="tabpanel" aria-labelledby="setup-tab" tabindex="0">
                <div class="card mt-3">
                    <div class="card-header">
                        Información General
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="course-name" class="form-label">Curso</label>
                                <input type="text" class="form-control" id="course-name" placeholder="Ej: Biología Celular">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="teacher-name" class="form-label">Docente</label>
                                <input type="text" class="form-control" id="teacher-name" placeholder="Ej: Dr. Ana Torres">
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="rubric-title" class="form-label">Título de la Evaluación</label>
                                <input type="text" class="form-control" id="rubric-title" placeholder="Ej: Reporte de Laboratorio N°5">
                            </div>
                             <div class="col-md-3 mb-3">
                                <label for="unit-name" class="form-label">Unidad</label>
                                <input type="text" class="form-control" id="unit-name" placeholder="Ej: Unidad 2">
                            </div>
                            <div class="col-md-3 mb-3">
                                <label for="evaluation-date" class="form-label">Fecha</label>
                                <input type="date" class="form-control" id="evaluation-date">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        Gestión de Estudiantes
                    </div>
                    <div class="card-body">
                         <div class="mb-3">
                            <label for="student-list-paste" class="form-label">Pega una nueva lista de estudiantes aquí (uno por línea)</label>
                            <textarea class="form-control" id="student-list-paste" rows="5"></textarea>
                        </div>
                        <button class="btn btn-primary" id="process-students-btn"><i class="bi bi-arrow-right-square"></i> Procesar y Usar Lista</button>
                    </div>
                </div>
            </div>

            <!-- Pestaña 2: Rúbrica -->
            <div class="tab-pane fade" id="rubric-pane" role="tabpanel" aria-labelledby="rubric-tab" tabindex="0">
                 <div class="card mt-3">
                    <div class="card-header">
                        Constructor de Rúbrica
                    </div>
                    <div class="card-body">
                        <div class="d-flex gap-2 mb-3">
                           <button class="btn btn-primary" id="add-criterion-btn"><i class="bi bi-plus-circle"></i> Añadir Criterio</button>
                           <button class="btn btn-primary" id="add-level-btn"><i class="bi bi-plus-square"></i> Añadir Nivel</button>
                           <button class="btn btn-info" data-bs-toggle="modal" data-bs-target="#importCsvModal"><i class="bi bi-file-earmark-spreadsheet"></i> Importar desde CSV</button>
                        </div>

                        <div id="rubric-builder" class="table-responsive">
                            <table class="table table-bordered">
                                <thead id="rubric-head">
                                    <tr>
                                        <th style="width: 20%;">Criterio</th>
                                        <!-- Los niveles se añadirán dinámicamente -->
                                    </tr>
                                </thead>
                                <tbody id="rubric-body">
                                    <!-- Las filas de criterios se añadirán dinámicamente -->
                                </tbody>
                            </table>
                        </div>
                        <hr>
                        <div class="row align-items-end">
                            <div class="col-md-6">
                                <label for="saved-rubrics" class="form-label">Cargar rúbrica guardada</label>
                                <select class="form-select" id="saved-rubrics">
                                    <option selected disabled>Selecciona una rúbrica...</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <button class="btn btn-success me-2" id="load-rubric-btn"><i class="bi bi-upload"></i> Cargar</button>
                                <button class="btn btn-secondary me-2" id="save-rubric-btn"><i class="bi bi-save"></i> Guardar Rúbrica Actual</button>
                                <button class="btn btn-danger" id="delete-rubric-btn"><i class="bi bi-trash"></i> Borrar Rúbrica</button>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>
            
            <!-- Pestaña 3: Grupos -->
            <div class="tab-pane fade" id="groups-pane" role="tabpanel" aria-labelledby="groups-tab" tabindex="0">
                 <div class="card mt-3">
                    <div class="card-header">
                        Creación de Grupos
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card bg-light p-3 mb-3">
                                    <label class="form-label fw-bold">Gestión de Listas Guardadas</label>
                                    <div class="input-group">
                                        <select class="form-select" id="saved-student-lists" aria-label="Cargar lista de estudiantes guardada">
                                            <option selected disabled>Selecciona una lista para cargar...</option>
                                        </select>
                                        <button class="btn btn-success" type="button" id="load-student-list-btn" title="Cargar Lista"><i class="bi bi-upload"></i> Cargar</button>
                                        <button class="btn btn-danger" type="button" id="delete-student-list-btn" title="Borrar Lista Seleccionada"><i class="bi bi-trash"></i> Borrar</button>
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <h5 class="mb-0">1. Estudiantes de la lista: <strong id="current-list-name-display" class="text-primary"></strong> (<span id="student-count">0</span>)</h5>
                                    <button class="btn btn-sm btn-secondary" id="save-student-list-btn" title="Guardar Lista Actual"><i class="bi bi-save"></i> Guardar Lista Actual</button>
                                </div>
                                <div id="group-student-selection" class="list-group" style="max-height: 400px; overflow-y: auto;">
                                    <!-- Lista de estudiantes para seleccionar -->
                                </div>
                            </div>
                            <div class="col-md-6">
                                <h5>2. Nombra y crea el grupo</h5>
                                <div class="mb-3">
                                    <label for="group-name" class="form-label">Nombre del Grupo</label>
                                    <input type="text" class="form-control" id="group-name" placeholder="Ej: Grupo 1, Los Investigadores...">
                                </div>
                                <button class="btn btn-primary" id="create-group-btn"><i class="bi bi-plus-circle-fill"></i> Crear Grupo</button>
                                <hr>
                                <h5>Grupos Creados</h5>
                                <div id="groups-display-area">
                                    <!-- Los grupos creados aparecerán aquí -->
                                </div>
                            </div>
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Pestaña 4: Evaluar -->
            <div class="tab-pane fade" id="evaluate-pane" role="tabpanel" aria-labelledby="evaluate-tab" tabindex="0">
                <div class="card mt-3">
                    <div class="card-header">
                        Panel de Evaluación
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-4">
                                <label for="group-to-evaluate" class="form-label">1. Selecciona un grupo para evaluar</label>
                                <select class="form-select" id="group-to-evaluate">
                                     <option selected disabled>Elige un grupo...</option>
                                </select>
                            </div>
                             <div class="col-md-4">
                                <label for="rubric-to-use" class="form-label">2. Selecciona una rúbrica</label>
                                <select class="form-select" id="rubric-to-use">
                                     <option selected disabled>Elige una rúbrica...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                               <div id="evaluation-results-display" class="d-flex flex-wrap gap-2">
                                   <!-- Los resultados se mostrarán aquí -->
                               </div>
                            </div>
                        </div>
                        <hr>
                        <div id="evaluation-rubric-area" class="table-responsive">
                            <!-- La rúbrica para evaluar se mostrará aquí -->
                        </div>
                        <div id="individual-evaluation-area" class="mt-4">
                            <!-- El área para evaluación individual aparecerá aquí -->
                        </div>
                        <button class="btn btn-success mt-3" id="save-evaluation-btn"><i class="bi bi-check-circle"></i> Guardar Evaluación</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header" id="final-results-header">
                       <h5 class="mb-0">Resultados Finales</h5>
                    </div>
                    <div class="card-body" id="results-area">
                        <!-- Pestañas de resultados por lista -->
                        <ul class="nav nav-tabs" id="results-tabs-nav" role="tablist"></ul>
                        <div class="tab-content" id="results-tabs-content"></div>
                    </div>
                </div>
            </div>

        </div>
    </div>

    <!-- Modal para guardar lista de estudiantes -->
    <div class="modal fade" id="saveStudentListModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Guardar Lista de Estudiantes</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label for="student-list-name" class="form-label">Nombre para identificar la lista</label>
            <input type="text" class="form-control" id="student-list-name" placeholder="Ej: Biología 4to A - 2024">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirm-save-student-list">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para guardar rúbrica -->
    <div class="modal fade" id="saveRubricModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Guardar Rúbrica</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <label for="rubric-name" class="form-label">Nombre para identificar la rúbrica</label>
            <input type="text" class="form-control" id="rubric-name" placeholder="Ej: Rúbrica para Ensayos">
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
            <button type="button" class="btn btn-primary" id="confirm-save-rubric">Guardar</button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal para importar CSV -->
    <div class="modal fade" id="importCsvModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Importar Rúbrica desde CSV</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>El importador detectará automáticamente el separador (coma o punto y coma).</p>
                    <p><b>Formato Requerido:</b></p>
                    <p class="mb-1">La <b>primera fila</b> define los niveles y sus puntajes. La segunda columna debe ser "Criterio".</p>
                    <code>,Criterio,Nombre Nivel 1 (Puntaje),Nombre Nivel 2 (Puntaje),...</code>
                    <p class="mt-2 mb-1">Las <b>siguientes filas</b> definen cada criterio y sus descriptores.</p>
                    <code>,Nombre del Criterio,"Descriptor Nivel 1","Descriptor Nivel 2",...</code>
                    <p class="mt-2"><small class="text-muted">Los textos que contengan el separador o saltos de línea deben ir entre comillas dobles (" ").</small></p>
                    <textarea id="csv-input" class="form-control" rows="10" placeholder=',Criterio,Nivel 1 (1 punto),Nivel 2 (3 puntos),Nivel 3 (5 puntos)
,Claridad de ideas,"Las ideas son confusas.","Las ideas son claras pero poco coherentes.","Todas las ideas son claras y coherentes."
,Organización,"No existe organización.","La organización es básica.","La organización es excelente y lógica."'></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-primary" id="confirm-import-csv">Importar Rúbrica</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js" xintegrity="sha384-YvpcrYf0tY3lHB60NNkmXc5s9fDVZLESaAA55NDzOxhy9GkcIdslK1eN7N6jIeHz" crossorigin="anonymous"></script>
    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- jsPDF autotable plugin -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    
    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // State Management
        let appState = {
            students: [],
            rubric: { criteria: [], levels: [] }, // This is now for the builder mainly
            groups: [],
            evaluations: {},
            generalInfo: {}
        };
        let currentListName = 'Lista sin Guardar'; // Track the current list being used for grouping

        // DOM Elements
        const studentListPaste = document.getElementById('student-list-paste');
        const processStudentsBtn = document.getElementById('process-students-btn');
        const studentListDisplay = document.getElementById('student-list-display');
        const studentCount = document.getElementById('student-count');
        const saveStudentListBtn = document.getElementById('save-student-list-btn');
        const confirmSaveStudentListBtn = document.getElementById('confirm-save-student-list');
        const savedStudentListsSelect = document.getElementById('saved-student-lists');
        const loadStudentListBtn = document.getElementById('load-student-list-btn');
        const deleteStudentListBtn = document.getElementById('delete-student-list-btn');
        const currentListNameDisplay = document.getElementById('current-list-name-display');
        
        const addCriterionBtn = document.getElementById('add-criterion-btn');
        const addLevelBtn = document.getElementById('add-level-btn');
        const rubricHead = document.getElementById('rubric-head');
        const rubricBody = document.getElementById('rubric-body');
        const saveRubricBtn = document.getElementById('save-rubric-btn');
        const confirmSaveRubricBtn = document.getElementById('confirm-save-rubric');
        const savedRubricsSelect = document.getElementById('saved-rubrics');
        const loadRubricBtn = document.getElementById('load-rubric-btn');
        const deleteRubricBtn = document.getElementById('delete-rubric-btn');
        const importCsvBtn = document.getElementById('confirm-import-csv');

        const groupStudentSelection = document.getElementById('group-student-selection');
        const createGroupBtn = document.getElementById('create-group-btn');
        const groupNameInput = document.getElementById('group-name');
        const groupsDisplayArea = document.getElementById('groups-display-area');
        
        const groupToEvaluateSelect = document.getElementById('group-to-evaluate');
        const rubricToUseSelect = document.getElementById('rubric-to-use');
        const evaluationRubricArea = document.getElementById('evaluation-rubric-area');
        const individualEvaluationArea = document.getElementById('individual-evaluation-area');
        const evaluationResultsDisplay = document.getElementById('evaluation-results-display');
        const saveEvaluationBtn = document.getElementById('save-evaluation-btn');
        const resultsArea = document.getElementById('results-area');
        
        const resultsTabsNav = document.getElementById('results-tabs-nav');
        const resultsTabsContent = document.getElementById('results-tabs-content');


        const courseNameInput = document.getElementById('course-name');
        const teacherNameInput = document.getElementById('teacher-name');
        const rubricTitleInput = document.getElementById('rubric-title');
        const unitNameInput = document.getElementById('unit-name');
        const evaluationDateInput = document.getElementById('evaluation-date');
        const clearAllDataBtn = document.getElementById('clear-all-data');

        // Modals
        const saveStudentListModal = new bootstrap.Modal(document.getElementById('saveStudentListModal'));
        const saveRubricModal = new bootstrap.Modal(document.getElementById('saveRubricModal'));
        const importCsvModal = new bootstrap.Modal(document.getElementById('importCsvModal'));

        // --- UTILS ---
        const saveState = () => {
            localStorage.setItem('rubricApp_state', JSON.stringify(appState));
        };
        
        const loadState = () => {
            const savedState = localStorage.getItem('rubricApp_state');
            if (savedState) {
                appState = JSON.parse(savedState);
                if (!appState.generalInfo) appState.generalInfo = {};
            }
        };

        const getFromStorage = (prefix) => {
            const items = {};
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith(prefix)) {
                    items[key] = JSON.parse(localStorage.getItem(key));
                }
            }
            return items;
        };
        
        const populateSelect = (selectElement, items, keyPrefix, prompt = 'Selecciona una opción...') => {
            const currentValue = selectElement.value;
            selectElement.innerHTML = `<option selected disabled>${prompt}</option>`;
            for (const key in items) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = key.replace(keyPrefix, '');
                selectElement.appendChild(option);
            }
            selectElement.value = currentValue;
        };

        const getPerformanceLevel = (avg) => {
            if(avg === null || avg === undefined) return "N/A";
            const avgNum = parseFloat(avg);
            if (avgNum === 5) return "Destacado";
            if (avgNum >= 4) return "Logrado";
            if (avgNum >= 3) return "Proceso";
            if (avgNum >= 2) return "Inicio";
            return "Previo al Inicio";
        };
        
        // --- DATA INITIALIZATION ---
        const initializeApp = () => {
            loadState();
            evaluationDateInput.valueAsDate = new Date();
            updateCurrentListNameDisplay();
            renderStudentsForGrouping();
            renderRubricBuilder();
            loadSavedLists();
            loadSavedRubrics();
            populateRubricSelectForEvaluation();
            renderGroups();
            populateEvaluationSelect();
            renderAllResults();
            updateGeneralInfoInputs();
            
            [courseNameInput, teacherNameInput, rubricTitleInput, unitNameInput, evaluationDateInput].forEach(input => {
                input.addEventListener('change', () => {
                    appState.generalInfo[input.id.replace('-name', '').replace('-','')] = input.value;
                    saveState();
                });
            });
        };

        const updateGeneralInfoInputs = () => {
            courseNameInput.value = appState.generalInfo.course || '';
            teacherNameInput.value = appState.generalInfo.teacher || '';
            rubricTitleInput.value = appState.generalInfo.rubricTitle || '';
            unitNameInput.value = appState.generalInfo.unit || '';
            evaluationDateInput.value = appState.generalInfo.evaluationDate || new Date().toISOString().split('T')[0];
        };
        
        const updateCurrentListNameDisplay = () => {
            currentListNameDisplay.textContent = currentListName;
        }

        // --- STUDENT MANAGEMENT ---
        const renderStudentsForGrouping = () => {
            groupStudentSelection.innerHTML = '';
            studentCount.textContent = appState.students.length;
            const studentsInGroups = new Set(appState.groups.flatMap(g => g.members));
            
            appState.students.forEach(student => {
                const studentItem = document.createElement('div');
                studentItem.className = 'list-group-item student-list-item';
                studentItem.textContent = student;
                studentItem.dataset.studentName = student;

                if (studentsInGroups.has(student)) {
                    studentItem.classList.add('unavailable');
                } else {
                    studentItem.addEventListener('click', () => {
                        studentItem.classList.toggle('selected');
                    });
                }
                groupStudentSelection.appendChild(studentItem);
            });
        };

        processStudentsBtn.addEventListener('click', () => {
            const names = studentListPaste.value.trim().split('\n').filter(name => name.trim() !== '');
            if(names.length === 0) {
                alert('Por favor, pega una lista de estudiantes.');
                return;
            }
            appState.students = [...new Set(names)]; // Remove duplicates
            currentListName = 'Lista sin Guardar';
            studentListPaste.value = '';
            saveState();
            updateCurrentListNameDisplay();
            renderStudentsForGrouping();
            // Switch to groups tab
            const groupsTab = new bootstrap.Tab(document.getElementById('groups-tab'));
            groupsTab.show();
        });

        const loadSavedLists = () => {
            const lists = getFromStorage('studentList_');
            populateSelect(savedStudentListsSelect, lists, 'studentList_', 'Selecciona una lista para cargar...');
        };

        saveStudentListBtn.addEventListener('click', () => {
            if (appState.students.length > 0) {
                document.getElementById('student-list-name').value = currentListName === 'Lista sin Guardar' ? '' : currentListName;
                saveStudentListModal.show();
            } else {
                alert('No hay estudiantes en la lista actual para guardar.');
            }
        });

        confirmSaveStudentListBtn.addEventListener('click', () => {
            const listName = document.getElementById('student-list-name').value.trim();
            if (listName) {
                localStorage.setItem(`studentList_${listName}`, JSON.stringify(appState.students));
                currentListName = listName;
                saveStudentListModal.hide();
                loadSavedLists();
                updateCurrentListNameDisplay();
            } else {
                alert('Por favor, ingresa un nombre para la lista.');
            }
        });
        
        loadStudentListBtn.addEventListener('click', () => {
            const selectedKey = savedStudentListsSelect.value;
            if (selectedKey.startsWith('studentList_')) {
                appState.students = JSON.parse(localStorage.getItem(selectedKey));
                currentListName = selectedKey.replace('studentList_', '');
                saveState();
                updateCurrentListNameDisplay();
                renderStudentsForGrouping();
            }
        });

        deleteStudentListBtn.addEventListener('click', () => {
            const selectedKey = savedStudentListsSelect.value;
            if (!selectedKey.startsWith('studentList_')) return;

            const listName = selectedKey.replace('studentList_', '');

            if (confirm(`¿Estás seguro de que quieres borrar la lista "${listName}"? Esta acción también eliminará todos los grupos y evaluaciones asociados a esta lista.`)) {
                
                const groupsToDelete = appState.groups.filter(g => g.listName === listName);
                
                groupsToDelete.forEach(group => {
                    if (appState.evaluations[group.name]) {
                        delete appState.evaluations[group.name];
                    }
                });

                appState.groups = appState.groups.filter(g => g.listName !== listName);

                localStorage.removeItem(selectedKey);
                
                if (currentListName === listName) {
                    appState.students = [];
                    currentListName = 'Lista sin Guardar';
                    updateCurrentListNameDisplay();
                }

                saveState();
                loadSavedLists();
                renderGroups();
                populateEvaluationSelect();
                renderStudentsForGrouping();
                renderAllResults();
            }
        });
        
        // --- RUBRIC MANAGEMENT ---
        const renderRubricBuilder = () => {
            let headerHTML = '<tr><th style="width: 20%;">Criterio</th>';
            appState.rubric.levels.forEach((level, index) => {
                headerHTML += `<th class="text-center">
                    <input type="text" class="form-control form-control-sm text-center level-header" value="${level.name}" data-level-index="${index}" placeholder="Nivel ${index+1}">
                    <button class="btn btn-sm btn-outline-danger mt-1 remove-level-btn" data-level-index="${index}"><i class="bi bi-trash"></i></button>
                </th>`;
            });
            headerHTML += '</tr>';
            rubricHead.innerHTML = headerHTML;

            let bodyHTML = '';
            appState.rubric.criteria.forEach((criterion, critIndex) => {
                bodyHTML += `<tr data-criterion-index="${critIndex}">
                    <td>
                        <textarea class="form-control form-control-sm criterion-name" rows="2" placeholder="Nombre del criterio">${criterion.name}</textarea>
                        <button class="btn btn-sm btn-outline-danger mt-1 remove-criterion-btn" data-criterion-index="${critIndex}"><i class="bi bi-trash"></i></button>
                    </td>`;
                appState.rubric.levels.forEach((level, levelIndex) => {
                    const cell = criterion.cells[levelIndex] || { descriptor: '', score: 0 };
                    bodyHTML += `<td>
                        <textarea class="form-control form-control-sm descriptor" rows="3" placeholder="Descriptor...">${cell.descriptor}</textarea>
                        <input type="number" step="0.1" class="form-control form-control-sm mt-1 score" value="${cell.score}" placeholder="Puntaje">
                    </td>`;
                });
                bodyHTML += `</tr>`;
            });
            rubricBody.innerHTML = bodyHTML;
            addRubricBuilderListeners();
        };

        const addRubricBuilderListeners = () => {
            document.querySelectorAll('#rubric-builder input, #rubric-builder textarea').forEach(input => {
                input.addEventListener('change', updateRubricFromBuilder);
            });
            document.querySelectorAll('.remove-criterion-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const critIndex = parseInt(e.currentTarget.dataset.criterionIndex);
                    appState.rubric.criteria.splice(critIndex, 1);
                    saveState();
                    renderRubricBuilder();
                });
            });
             document.querySelectorAll('.remove-level-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const levelIndex = parseInt(e.currentTarget.dataset.levelIndex);
                    appState.rubric.levels.splice(levelIndex, 1);
                    appState.rubric.criteria.forEach(crit => {
                        crit.cells.splice(levelIndex, 1);
                    });
                    saveState();
                    renderRubricBuilder();
                });
            });
        };

        const updateRubricFromBuilder = () => {
            const newLevels = [];
            document.querySelectorAll('.level-header').forEach((input) => {
                newLevels.push({ name: input.value.trim() });
            });
            appState.rubric.levels = newLevels;

            const newCriteria = [];
            document.querySelectorAll('#rubric-body tr').forEach(row => {
                const criterionName = row.querySelector('.criterion-name').value.trim();
                const cells = [];
                row.querySelectorAll('td:not(:first-child)').forEach(cellEl => {
                    const descriptor = cellEl.querySelector('.descriptor').value.trim();
                    const score = parseFloat(cellEl.querySelector('.score').value) || 0;
                    cells.push({ descriptor, score });
                });
                if(criterionName) newCriteria.push({ name: criterionName, cells });
            });
            appState.rubric.criteria = newCriteria;
            saveState();
        };

        addCriterionBtn.addEventListener('click', () => {
            const newCriterion = { name: '', cells: appState.rubric.levels.map(() => ({ descriptor: '', score: 0 })) };
            appState.rubric.criteria.push(newCriterion);
            renderRubricBuilder();
        });

        addLevelBtn.addEventListener('click', () => {
            const newLevelName = `Nivel ${appState.rubric.levels.length + 1}`;
            appState.rubric.levels.push({ name: newLevelName });
            appState.rubric.criteria.forEach(criterion => {
                criterion.cells.push({ descriptor: '', score: 0 });
            });
            renderRubricBuilder();
        });

        const loadSavedRubrics = () => {
            const rubrics = getFromStorage('rubric_');
            populateSelect(savedRubricsSelect, rubrics, 'rubric_');
            populateRubricSelectForEvaluation();
        };

        saveRubricBtn.addEventListener('click', () => {
            updateRubricFromBuilder();
            if(appState.rubric.criteria.length > 0 && appState.rubric.levels.length > 0) {
                 document.getElementById('rubric-name').value = '';
                saveRubricModal.show();
            } else {
                alert('La rúbrica está vacía. Añade criterios y niveles antes de guardar.');
            }
        });

        confirmSaveRubricBtn.addEventListener('click', () => {
            const rubricName = document.getElementById('rubric-name').value.trim();
            if (rubricName) {
                localStorage.setItem(`rubric_${rubricName}`, JSON.stringify(appState.rubric));
                saveRubricModal.hide();
                loadSavedRubrics();
            } else {
                alert('Por favor, ingresa un nombre para la rúbrica.');
            }
        });

        loadRubricBtn.addEventListener('click', () => {
            const selectedKey = savedRubricsSelect.value;
            if (selectedKey.startsWith('rubric_')) {
                appState.rubric = JSON.parse(localStorage.getItem(selectedKey));
                saveState();
                renderRubricBuilder();
            }
        });
        
        deleteRubricBtn.addEventListener('click', () => {
            const selectedKey = savedRubricsSelect.value;
            if (selectedKey.startsWith('rubric_') && confirm(`¿Estás seguro de que quieres borrar la rúbrica "${selectedKey.replace('rubric_','')}"?`)) {
                localStorage.removeItem(selectedKey);
                loadSavedRubrics();
            }
        });
        
        const parseCSV = (csvText) => {
            const text = csvText.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            
            const firstLine = text.substring(0, text.indexOf('\n'));
            const commaCount = (firstLine.match(/,/g) || []).length;
            const semicolonCount = (firstLine.match(/;/g) || []).length;
            const delimiter = semicolonCount > commaCount ? ';' : ',';

            const table = [];
            let currentRow = [];
            let currentField = '';
            let inQuotes = false;

            for (let i = 0; i < text.length; i++) {
                const char = text[i];

                if (inQuotes) {
                    if (char === '"') {
                        if (i + 1 < text.length && text[i + 1] === '"') {
                            currentField += '"';
                            i++;
                        } else {
                            inQuotes = false;
                        }
                    } else {
                        currentField += char;
                    }
                } else {
                    if (char === '"') {
                        inQuotes = true;
                    } else if (char === delimiter) {
                        currentRow.push(currentField.trim());
                        currentField = '';
                    } else if (char === '\n') {
                        currentRow.push(currentField.trim());
                        table.push(currentRow);
                        currentRow = [];
                        currentField = '';
                    } else {
                        currentField += char;
                    }
                }
            }
            
            if (currentField || currentRow.length > 0) {
                currentRow.push(currentField.trim());
                table.push(currentRow);
            }
            
            return table;
        };

        importCsvBtn.addEventListener('click', () => {
            const csvText = document.getElementById('csv-input').value.trim();
            if (!csvText) { alert('El campo CSV está vacío.'); return; }

            try {
                const table = parseCSV(csvText);

                if (table.length < 2) {
                    alert('El CSV debe tener al menos 2 filas: una para los encabezados y otra para un criterio.');
                    return;
                }
                
                const newRubric = { criteria: [], levels: [] };
                const skippedCriteria = [];

                const headerRow = table[0];
                if (headerRow.length < 3 || headerRow[1].trim().toLowerCase() !== 'criterio') {
                    alert('Error de formato en la primera fila. Debe ser: ,Criterio,Nombre Nivel 1 (Puntaje),Nombre Nivel 2 (Puntaje),...');
                    return;
                }

                const levelHeaders = headerRow.slice(2);
                const scores = [];
                levelHeaders.forEach(header => {
                    const match = header.match(/(.+)\s*\((\d+\.?\d*)/);
                    if (match) {
                        newRubric.levels.push({ name: match[1].trim() });
                        scores.push(parseFloat(match[2]));
                    } else {
                        newRubric.levels.push({ name: header.trim() });
                        scores.push(0);
                    }
                });
                
                for (let i = 1; i < table.length; i++) {
                    const cols = table[i];
                    if (cols.every(c => c.trim() === '')) continue;
                    
                    if (cols.length !== newRubric.levels.length + 2) {
                         const criterionNameGuess = cols[1] || `Fila ${i+1}`;
                         skippedCriteria.push(criterionNameGuess);
                         continue;
                    }

                    const criterionName = cols[1].trim();
                    if (!criterionName) continue;

                    const descriptors = cols.slice(2);
                    const cells = [];
                    descriptors.forEach((descriptor, index) => {
                        cells.push({
                            descriptor: descriptor.trim(),
                            score: scores[index] !== undefined ? scores[index] : 0
                        });
                    });
                    
                    newRubric.criteria.push({ name: criterionName, cells });
                }

                appState.rubric = newRubric;
                saveState();
                renderRubricBuilder();
                importCsvModal.hide();
                
                if (skippedCriteria.length > 0) {
                    alert(`Rúbrica importada, pero se omitieron los siguientes criterios por tener un formato incorrecto:\n\n- ${skippedCriteria.join('\n- ')}`);
                } else if (newRubric.criteria.length > 0) {
                    alert('Rúbrica importada con éxito.');
                } else {
                    alert('Se procesó el CSV, pero no se encontraron criterios válidos.');
                }

            } catch(error) {
                alert('Ocurrió un error inesperado al procesar el CSV.');
                console.error(error);
            }
        });

        // --- GROUP MANAGEMENT ---
        createGroupBtn.addEventListener('click', () => {
            const selectedStudents = Array.from(document.querySelectorAll('#group-student-selection .student-list-item.selected'))
                .map(item => item.dataset.studentName);
            const groupName = groupNameInput.value.trim();

            if (!groupName) { alert('Por favor, ingresa un nombre para el grupo.'); return; }
            if (selectedStudents.length === 0) { alert('Selecciona al menos un estudiante para el grupo.'); return; }

            appState.groups.push({ name: groupName, members: selectedStudents, listName: currentListName });
            saveState();
            renderGroups();
            populateEvaluationSelect();
            renderStudentsForGrouping();
            renderAllResults(); 
            groupNameInput.value = '';
        });

        const renderGroups = () => {
            groupsDisplayArea.innerHTML = '';
            appState.groups.forEach((group, index) => {
                const groupCard = document.createElement('div');
                groupCard.className = 'card mb-2';
                let membersHTML = group.members.map(m => `<span class="badge bg-secondary me-1">${m}</span>`).join('');
                groupCard.innerHTML = `
                    <div class="card-body p-2">
                        <div class="d-flex justify-content-between align-items-center">
                            <h6 class="card-title mb-0">${group.name} (${group.listName})</h6>
                            <button class="btn btn-sm btn-outline-danger remove-group-btn" data-group-index="${index}"><i class="bi bi-trash"></i></button>
                        </div>
                        <p class="card-text small mt-1">${membersHTML}</p>
                    </div>`;
                groupsDisplayArea.appendChild(groupCard);
            });
             document.querySelectorAll('.remove-group-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const index = parseInt(e.currentTarget.dataset.groupIndex);
                    const groupNameToDelete = appState.groups[index]?.name;
                    
                    if (groupNameToDelete) {
                        appState.groups.splice(index, 1);
                        delete appState.evaluations[groupNameToDelete];
                    }
                    saveState();
                    renderGroups();
                    populateEvaluationSelect();
                    renderStudentsForGrouping();
                    renderAllResults();
                });
            });
        };

        // --- EVALUATION ---
        const populateEvaluationSelect = () => {
            const currentVal = groupToEvaluateSelect.value;
            groupToEvaluateSelect.innerHTML = '<option selected disabled>Elige un grupo...</option>';
            appState.groups.forEach(group => {
                const option = document.createElement('option');
                option.value = group.name;
                option.textContent = `${group.name} (${group.listName})`;
                groupToEvaluateSelect.appendChild(option);
            });
            groupToEvaluateSelect.value = currentVal;
        };

        const populateRubricSelectForEvaluation = () => {
            const rubrics = getFromStorage('rubric_');
            populateSelect(rubricToUseSelect, rubrics, 'rubric_');
        };
        
        groupToEvaluateSelect.addEventListener('change', () => {
            const groupName = groupToEvaluateSelect.value;
            const evaluation = appState.evaluations[groupName];

            if (evaluation && evaluation.rubricName) {
                rubricToUseSelect.value = `rubric_${evaluation.rubricName}`;
                rubricToUseSelect.disabled = true;
            } else {
                rubricToUseSelect.disabled = false;
            }
            renderEvaluationUI(groupName);
        });

        rubricToUseSelect.addEventListener('change', () => {
            renderEvaluationUI(groupToEvaluateSelect.value);
        });

        const renderEvaluationUI = (groupName) => {
            const rubricKey = rubricToUseSelect.value;
            if (!groupName || !rubricKey.startsWith('rubric_')) {
                evaluationRubricArea.innerHTML = '';
                individualEvaluationArea.innerHTML = '';
                evaluationResultsDisplay.innerHTML = '';
                return;
            };
            const rubric = JSON.parse(localStorage.getItem(rubricKey));
            if (!rubric) {
                evaluationRubricArea.innerHTML = '<p class="text-danger">Rúbrica no encontrada. Por favor, selecciona una válida.</p>';
                return;
            }
            renderEvaluationRubric(groupName, rubric);
            renderIndividualEvaluation(groupName);
            updateEvaluationResults(groupName, rubric);
        }

        const renderEvaluationRubric = (groupName, rubric) => {
            let tableHTML = `<h5 class="text-primary">Evaluación del Trabajo Grupal</h5><table class="table table-bordered table-hover rubric-table"><thead><tr><th style="width: 25%;">Criterio</th>`;
            rubric.levels.forEach(level => {
                tableHTML += `<th class="text-center">${level.name}</th>`;
            });
            tableHTML += `</tr></thead><tbody>`;

            const groupEval = appState.evaluations[groupName];
            const groupScores = groupEval?.groupScores || {};

            rubric.criteria.forEach((criterion) => {
                tableHTML += `<tr><td><strong>${criterion.name}</strong></td>`;
                criterion.cells.forEach((cell) => {
                    const isSelected = groupScores[criterion.name] === cell.score ? 'selected-cell' : '';
                    tableHTML += `<td class="text-center selectable-cell ${isSelected}" data-criterion-name="${criterion.name}" data-score="${cell.score}">
                        <p class="descriptor">${cell.descriptor}</p>
                        <strong class="text-primary">${cell.score} pts</strong>
                    </td>`;
                });
                tableHTML += `</tr>`;
            });

            tableHTML += '</tbody></table>';
            evaluationRubricArea.innerHTML = tableHTML;
            
            document.querySelectorAll('#evaluation-rubric-area .selectable-cell').forEach(cell => {
                cell.addEventListener('click', (e) => {
                    const clickedCell = e.currentTarget;
                    const row = clickedCell.parentElement;
                    row.querySelectorAll('.selectable-cell').forEach(c => c.classList.remove('selected-cell'));
                    clickedCell.classList.add('selected-cell');
                    updateEvaluationResults(groupName, rubric);
                });
            });
        };

        const renderIndividualEvaluation = (groupName) => {
            const group = appState.groups.find(g => g.name === groupName);
            if (!group) { individualEvaluationArea.innerHTML = ''; return; }
            
            const groupEval = appState.evaluations[groupName];
            const groupAverage = groupEval ? groupEval.groupAverage : 0;

            let tableHTML = `<h5 class="text-primary mt-4">Evaluación Individual de Miembros</h5>
            <table class="table table-striped"><thead><tr><th>Estudiante</th><th>Nota Final Individual</th><th>Comentarios / Observaciones</th></tr></thead><tbody>`;

            group.members.forEach(member => {
                const memberEval = groupEval?.memberEvaluations.find(m => m.name === member);
                const score = memberEval ? memberEval.finalScore : groupAverage;
                const comments = memberEval ? memberEval.comments : '';

                const isManual = memberEval && Math.abs(memberEval.finalScore - groupAverage) > 0.001;
                const manualAttr = isManual ? 'data-manual-edit="true"' : '';

                tableHTML += `
                    <tr data-member-name="${member}">
                        <td>${member}</td>
                        <td><input type="number" step="0.1" class="form-control individual-score" value="${score.toFixed(2)}" ${manualAttr}></td>
                        <td><textarea class="form-control individual-comment" rows="1">${comments}</textarea></td>
                    </tr>`;
            });
            tableHTML += `</tbody></table>`;
            individualEvaluationArea.innerHTML = tableHTML;

            document.querySelectorAll('#individual-evaluation-area .individual-score').forEach(input => {
                input.addEventListener('input', (e) => {
                    e.currentTarget.dataset.manualEdit = 'true';
                });
            });
        };

        const updateEvaluationResults = (groupName, rubric) => {
            if (!groupName || !rubric) return;

            let totalScore = 0;
            document.querySelectorAll('#evaluation-rubric-area .selected-cell').forEach(cell => {
                totalScore += parseFloat(cell.dataset.score);
            });
            
            const numCriteria = rubric.criteria.length;
            const newAverage = numCriteria > 0 ? (totalScore / numCriteria) : 0;
            const newAverageString = newAverage.toFixed(2);
            const level = getPerformanceLevel(newAverageString);

            evaluationResultsDisplay.innerHTML = `
                <div class="text-center">
                    Puntaje: <span class="badge bg-primary evaluation-results">${totalScore}</span>
                </div>
                <div class="text-center">
                    Promedio: <span class="badge bg-info evaluation-results">${newAverageString}</span>
                </div>
                <div class="text-center">
                    Nivel: <span class="badge bg-success evaluation-results">${level}</span>
                </div>
            `;
            
            document.querySelectorAll('#individual-evaluation-area tr[data-member-name]').forEach(row => {
                const scoreInput = row.querySelector('.individual-score');
                if (scoreInput.dataset.manualEdit !== 'true') {
                    scoreInput.value = newAverageString;
                }
            });
        };

        saveEvaluationBtn.addEventListener('click', () => {
            const groupName = groupToEvaluateSelect.value;
            const rubricKey = rubricToUseSelect.value;
            if (!groupName || !rubricKey.startsWith('rubric_')) { alert('Selecciona un grupo y una rúbrica para guardar la evaluación.'); return; }
            
            const rubricName = rubricKey.replace('rubric_','');
            const rubric = JSON.parse(localStorage.getItem(rubricKey));

            const newEvaluation = { groupScores: {}, memberEvaluations: [], rubricName };
            let totalScore = 0;
            document.querySelectorAll('#evaluation-rubric-area .selected-cell').forEach(cell => {
                const score = parseFloat(cell.dataset.score);
                totalScore += score;
                newEvaluation.groupScores[cell.dataset.criterionName] = score;
            });

            const numCriteria = rubric.criteria.length;
            newEvaluation.groupTotalScore = totalScore;
            newEvaluation.groupAverage = numCriteria > 0 ? (totalScore / numCriteria) : 0;
            newEvaluation.groupLevel = getPerformanceLevel(newEvaluation.groupAverage);

            document.querySelectorAll('#individual-evaluation-area tr[data-member-name]').forEach(row => {
                const name = row.dataset.memberName;
                const finalScore = parseFloat(row.querySelector('.individual-score').value);
                const comments = row.querySelector('.individual-comment').value;
                newEvaluation.memberEvaluations.push({
                    name,
                    finalScore,
                    finalLevel: getPerformanceLevel(finalScore),
                    comments
                });
            });
            
            appState.evaluations[groupName] = newEvaluation;
            saveState();
            alert(`Evaluación para ${groupName} guardada.`);
            renderAllResults();
        });

        // --- RESULTS & EXPORT ---
        const renderAllResults = () => {
            resultsTabsNav.innerHTML = '';
            resultsTabsContent.innerHTML = '';

            const listNames = [...new Set(appState.groups.map(g => g.listName))].filter(Boolean);
            if (listNames.length === 0) {
                 resultsTabsContent.innerHTML = '<p class="text-muted p-3">No hay grupos creados para mostrar resultados.</p>';
                 return;
            }

            listNames.forEach((listName, index) => {
                const isActive = index === 0;
                const safeIdPart = (listName || 'unnamed').replace(/[^a-zA-Z0-9]/g, '') + index;
                const tabId = `list-tab-${safeIdPart}`;
                const paneId = `list-pane-${safeIdPart}`;

                // Create Nav Tab
                resultsTabsNav.innerHTML += `
                    <li class="nav-item" role="presentation">
                        <button class="nav-link ${isActive ? 'active' : ''}" id="${tabId}" data-bs-toggle="tab" data-bs-target="#${paneId}" type="button" role="tab" aria-controls="${paneId}" aria-selected="${isActive}">${listName}</button>
                    </li>`;

                // Create Tab Pane
                let paneContent = `<div class="p-2 d-flex justify-content-end mb-3"><button class="btn btn-sm btn-info export-list-pdf-btn" data-list-name="${listName}"><i class="bi bi-collection-fill"></i> Exportar Resultados de "${listName}"</button></div>`;
                const groupsInList = appState.groups.filter(g => g.listName === listName);
                
                groupsInList.forEach(group => {
                    const evaluation = appState.evaluations[group.name];
                    let cardBody;
                    if (evaluation) {
                        let membersEvalHTML = evaluation.memberEvaluations.map(m => `<li>${m.name}: <strong>${m.finalScore.toFixed(2)}</strong> (${m.finalLevel})</li>`).join('');
                        cardBody = `<h6><span class="badge bg-secondary">Promedio Grupal: ${evaluation.groupAverage.toFixed(2)}</span></h6>
                                    <p class="mb-1"><strong>Resultados Individuales:</strong></p>
                                    <ul class="list-unstyled small">${membersEvalHTML}</ul>`;
                    } else {
                        cardBody = `<p class="text-muted">Este grupo aún no ha sido evaluado.</p>`;
                    }
                    
                    paneContent += `
                        <div class="card mb-3">
                            <div class="card-header">
                                <h5 class="mb-0">${group.name}</h5>
                                <div class="btn-group btn-group-sm">
                                    <button class="btn btn-outline-primary edit-eval-btn" data-group-name="${group.name}"><i class="bi bi-pencil"></i> Modificar</button>
                                    <button class="btn btn-outline-secondary export-pdf-btn" data-group-name="${group.name}" ${!evaluation ? 'disabled' : ''}><i class="bi bi-file-earmark-pdf"></i> Exportar PDF</button>
                                </div>
                            </div>
                            <div class="card-body">${cardBody}</div>
                        </div>`;
                });

                resultsTabsContent.innerHTML += `<div class="tab-pane fade ${isActive ? 'show active' : ''}" id="${paneId}" role="tabpanel" aria-labelledby="${tabId}">${paneContent}</div>`;
            });
            
            attachResultsListeners();
        };
        
        const attachResultsListeners = () => {
             document.querySelectorAll('.edit-eval-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    const groupName = e.currentTarget.dataset.groupName;
                    groupToEvaluateSelect.value = groupName;
                    const evaluateTab = new bootstrap.Tab(document.getElementById('evaluate-tab'));
                    evaluateTab.show();
                    
                    const evaluation = appState.evaluations[groupName];
                    if (evaluation && evaluation.rubricName) {
                        rubricToUseSelect.value = `rubric_${evaluation.rubricName}`;
                        rubricToUseSelect.disabled = true;
                    } else {
                        rubricToUseSelect.disabled = false;
                    }
                    renderEvaluationUI(groupName);
                });
            });

            document.querySelectorAll('.export-pdf-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    exportGroupToPDF(e.currentTarget.dataset.groupName);
                });
            });

            document.querySelectorAll('.export-list-pdf-btn').forEach(btn => {
                btn.addEventListener('click', e => {
                    exportListToPDF(e.currentTarget.dataset.listName);
                });
            });
        };
        
        const generatePdfForGroup = (doc, groupName) => {
            const group = appState.groups.find(g => g.name === groupName);
            const evaluation = appState.evaluations[groupName];
            if (!group || !evaluation) return false;

            const rubric = JSON.parse(localStorage.getItem(`rubric_${evaluation.rubricName}`));
            if (!rubric) {
                console.error(`Rubric "${evaluation.rubricName}" not found for group "${groupName}"`);
                return false;
            }

            doc.setFontSize(18).text(rubricTitleInput.value || "Reporte de Evaluación", 14, 22);
            doc.setFontSize(11)
               .text(`Curso: ${courseNameInput.value || 'N/A'}`, 14, 32)
               .text(`Docente: ${teacherNameInput.value || 'N/A'}`, 14, 38)
               .text(`Fecha: ${evaluationDateInput.value || 'N/A'}`, 120, 32)
               .text(`Unidad: ${unitNameInput.value || 'N/A'}`, 120, 38);
            doc.setLineWidth(0.5).line(14, 42, 196, 42);

            doc.setFontSize(14).text(`Grupo: ${group.name} (Lista: ${group.listName})`, 14, 52);
            doc.setFontSize(11).text("Integrantes:", 14, 58);
            let membersText = doc.splitTextToSize(group.members.join(', '), 170);
            doc.text(membersText, 20, 64);
            
            let finalY = 64 + (membersText.length * 5) + 10;
            
            doc.setFontSize(12).setFont(undefined, 'bold').text("Resultados del Trabajo Grupal", 14, finalY);
            doc.setFont(undefined, 'normal')
               .text(`Puntaje Total Obtenido: ${evaluation.groupTotalScore}`, 20, finalY + 7)
               .text(`Promedio Final: ${evaluation.groupAverage.toFixed(2)}`, 20, finalY + 14)
               .text(`Nivel de Desempeño: ${evaluation.groupLevel}`, 20, finalY + 21);
            finalY += 30;

            const rubricHeadPDF = [['Criterio', 'Nivel Seleccionado', 'Descriptor', 'Puntaje Obtenido']];
            const rubricBodyPDF = rubric.criteria.map(criterion => {
                const score = evaluation.groupScores[criterion.name] || 0;
                let levelName = 'No evaluado', descriptor = 'N/A';
                for (let i = 0; i < criterion.cells.length; i++) {
                    if (criterion.cells[i].score === score) {
                        levelName = rubric.levels[i].name;
                        descriptor = criterion.cells[i].descriptor;
                        break;
                    }
                }
                return [criterion.name, levelName, descriptor, score];
            });

            doc.autoTable({
                head: rubricHeadPDF, body: rubricBodyPDF, startY: finalY,
                headStyles: { fillColor: [40, 167, 69] },
                columnStyles: { 2: { cellWidth: 'auto' } },
            });
            finalY = doc.autoTable.previous.finalY + 10;

            doc.setFontSize(12).setFont(undefined, 'bold').text("Resultados Individuales", 14, finalY);
            finalY += 7;

            const individualHead = [['Estudiante', 'Nota Final', 'Nivel', 'Comentarios']];
            const individualBody = evaluation.memberEvaluations.map(m => [m.name, m.finalScore.toFixed(2), m.finalLevel, m.comments]);
            doc.autoTable({
                head: individualHead, body: individualBody, startY: finalY,
                headStyles: { fillColor: [23, 162, 184] },
                columnStyles: { 3: { cellWidth: 'auto' } },
            });
            
            return true;
        }

        const exportGroupToPDF = (groupName) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const success = generatePdfForGroup(doc, groupName);
            if(success) doc.save(`Evaluacion_${groupName.replace(/ /g, '_')}.pdf`);
            else alert(`No se pudo generar el PDF para "${groupName}". Revisa que la evaluación esté completa y la rúbrica asociada exista.`);
        };

        const exportListToPDF = (listName) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            let firstPage = true;
            
            const groupsInList = appState.groups.filter(g => g.listName === listName);

            groupsInList.forEach(group => {
                if (appState.evaluations[group.name]) {
                    if (!firstPage) {
                        doc.addPage();
                    }
                    generatePdfForGroup(doc, group.name);
                    firstPage = false;
                }
            });

            if (firstPage) {
                alert(`No hay evaluaciones completadas para la lista "${listName}".`);
                return;
            }

            doc.save(`Reporte_Completo_${listName.replace(/ /g, '_')}.pdf`);
        };
        
        clearAllDataBtn.addEventListener('click', () => {
            if (confirm('¡ADVERTENCIA! Esta acción borrará permanentemente TODOS los datos guardados de este navegador. ¿Deseas continuar?')) {
                localStorage.clear();
                appState = { students: [], rubric: { criteria: [], levels: [] }, groups: [], evaluations: {}, generalInfo: {} };
                initializeApp();
                const inputsToClear = [ 'student-list-paste', 'group-name', 'course-name', 'teacher-name', 'rubric-title', 'unit-name' ];
                inputsToClear.forEach(id => document.getElementById(id).value = '');
                evaluationRubricArea.innerHTML = '';
                individualEvaluationArea.innerHTML = '';
                evaluationResultsDisplay.innerHTML = '';
            }
        });

        // First Load
        initializeApp();
    });
    </script>
</body>
</html>

